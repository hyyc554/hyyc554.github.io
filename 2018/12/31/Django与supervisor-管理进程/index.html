<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Django与supervisor 管理进程"/><meta name="keywords" content="Django, Linux, MadLife" /><link rel="alternate" href="/atom.xml" title="MadLife"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://hyyc554.github.io/2018/12/31/Django与supervisor-管理进程/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title>Django与supervisor 管理进程 - MadLife</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">MadLife</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/categories">
        <li class="mobile-menu-item">分类
          </li>
      </a><a href="/about">
        <li class="mobile-menu-item">关于
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">MadLife</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            分类
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about">
            关于
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">Django与supervisor 管理进程
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-12-31
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、前言"><span class="toc-text">1、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、安装"><span class="toc-text">2、安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、使用说明"><span class="toc-text">3、使用说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-查看默认配置"><span class="toc-text">3.1 查看默认配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-启动服务端"><span class="toc-text">3.2 启动服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-项目配置及运行"><span class="toc-text">3.2 项目配置及运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-使用supervisorctl"><span class="toc-text">3.3 使用supervisorctl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-多个进程管理"><span class="toc-text">3.4 多个进程管理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-结尾"><span class="toc-text">4. 结尾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料："><span class="toc-text">参考资料：</span></a></li></ol>
    </div>
  </div><div class="post-content"><h2 id="1、前言"><a href="#1、前言" class="headerlink" title="1、前言"></a>1、前言</h2><p>在Django项目中，我们需要用到一些独立于Django框架外的脚本。这样一些脚本可能需要独立的持续运行，且具有很强的可维护性，这个时候supervisor就可以排上用场了。</p>
<p><img src="https://ws1.sinaimg.cn/large/d126accegy1fyq9bijxgvj206h08hjrr.jpg" alt=""></p>
<a id="more"></a>
<ul>
<li><p>基于python编写，安装方便</p>
</li>
<li><p>进程管理工具，可以很方便的对用户定义的进程进行启动，关闭，重启，并且对意外关闭的进程进行重启 ，只需要简单的配置一下即可，且有web端，状态、日志查看清晰明了。</p>
</li>
<li><p>组成部分 </p>
<ul>
<li>supervisord[服务端，所以要通过这个来启动它]</li>
<li>supervisorctl[客户端，可以来执行stop等命令]</li>
</ul>
</li>
<li><p>官方文档地址：</p>
<p><a href="http://supervisord.org/" target="_blank" rel="noopener">http://supervisord.org/</a></p>
</li>
</ul>
<h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><p>直接使用pip进行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure>
<h2 id="3、使用说明"><a href="#3、使用说明" class="headerlink" title="3、使用说明"></a>3、使用说明</h2><p>使用supervisor很简单，只需要修改一些配置文件，就可以使用了。</p>
<h4 id="3-1-查看默认配置"><a href="#3-1-查看默认配置" class="headerlink" title="3.1 查看默认配置"></a>3.1 查看默认配置</h4><p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf</span><br></pre></td></tr></table></figure>
<p>即可看到默认配置情况，但是一般情况下，我们都不要去修改默认的配置，而是将默认配置重定向到另外的文件中，不同的进程运用不同的配置文件去对默认文件进行复写即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>默认配置说明</p>
<blockquote>
<p>默认的配置文件是下面这样的，但是这里有个坑需要注意，supervisord.pid 以及 supervisor.sock 是放在 /tmp 目录下，但是 /tmp 目录是存放临时文件，里面的文件是会被 Linux 系统删除的，一旦这些文件丢失，就无法再通过 supervisorctl 来执行 restart 和 stop 命令了，将只会得到 unix:///tmp/supervisor.sock 不存在的错误 。</p>
</blockquote>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[unix_http_server]</span></span><br><span class="line"><span class="comment">;file=/tmp/supervisor.sock   ; (the path to the socket file)</span></span><br><span class="line"><span class="comment">;建议修改为 /var/run 目录，避免被系统删除</span></span><br><span class="line"><span class="attr">file</span>=/var/run/supervisor.sock   ; (the path to the socket file)</span><br><span class="line"><span class="comment">;chmod=0700                 ; socket file mode (default 0700)</span></span><br><span class="line"><span class="comment">;chown=nobody:nogroup       ; socket file uid:gid owner</span></span><br><span class="line"><span class="comment">;username=user              ; (default is no username (open server))</span></span><br><span class="line"><span class="comment">;password=123               ; (default is no password (open server))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[inet_http_server]         ; inet (TCP) server disabled by default</span></span><br><span class="line"><span class="comment">;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port for ;all iface)</span></span><br><span class="line"><span class="comment">;username=user              ; (default is no username (open server))</span></span><br><span class="line"><span class="comment">;password=123               ; (default is no password (open server))</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="section">[supervisord]</span></span><br><span class="line"><span class="comment">;logfile=/tmp/supervisord.log ; 日志文件(main log file;default $CWD/supervisord.log)</span></span><br><span class="line"><span class="comment">;建议修改为 /var/log 目录，避免被系统删除</span></span><br><span class="line"><span class="attr">logfile</span>=/var/log/supervisor/supervisord.log ; (main log file;default <span class="variable">$CWD</span>/supervisord.log)</span><br><span class="line"><span class="attr">logfile_maxbytes</span>=<span class="number">50</span>MB        ; 日志文件大小(max main logfile bytes b4 rotation;default <span class="number">50</span>MB)</span><br><span class="line"><span class="attr">logfile_backups</span>=<span class="number">10</span>           ; 日志文件保留备份数量(num of main logfile rotation backups;default <span class="number">10</span>)</span><br><span class="line"><span class="attr">loglevel</span>=info                ; 日志级别(log level;default info; others: debug,warn,trace)</span><br><span class="line"><span class="comment">;pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</span></span><br><span class="line"><span class="comment">;建议修改为 /var/run 目录，避免被系统删除</span></span><br><span class="line"><span class="attr">pidfile</span>=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</span><br><span class="line"><span class="comment">;设置启动supervisord的用户，一般情况下不要轻易用root用户来启动，除非你真的确定要这么做</span></span><br><span class="line"><span class="comment">;user=chrism                 ; (default is current user, required if root)</span></span><br><span class="line"><span class="attr">nodaemon</span>=<span class="literal">false</span>               ; (start in foreground if <span class="literal">true</span>;default <span class="literal">false</span>)</span><br><span class="line"><span class="attr">minfds</span>=<span class="number">1024</span>                  ; (min. avail startup file descriptors;default <span class="number">1024</span>)</span><br><span class="line"><span class="attr">minprocs</span>=<span class="number">200</span>                 ; (min. avail process descriptors;default <span class="number">200</span>)</span><br><span class="line"><span class="comment">;umask=022                   ; (process file creation umask;default 022)</span></span><br><span class="line"><span class="comment">;identifier=supervisor       ; (supervisord identifier, default is 'supervisor')</span></span><br><span class="line"><span class="comment">;directory=/tmp              ; (default is not to cd during start)</span></span><br><span class="line"><span class="comment">;nocleanup=true              ; (don't clean up tempfiles at start;default false)</span></span><br><span class="line"><span class="comment">;childlogdir=/tmp            ; ('AUTO' child log dir, default $TEMP)</span></span><br><span class="line"><span class="comment">;environment=KEY="value"     ; (key value pairs to add to environment)</span></span><br><span class="line"><span class="comment">;strip_ansi=false            ; (strip ansi escape codes in logs; def. false)</span></span><br><span class="line"></span><br><span class="line"><span class="section">[unix_http_server]</span></span><br><span class="line"><span class="attr">file</span>=/tmp/supervisor.sock   ; (the path to the socket file)</span><br><span class="line"><span class="comment">;chmod=0700                 ; socket file mode (default 0700)</span></span><br><span class="line"><span class="comment">;chown=nobody:nogroup       ; socket file uid:gid owner</span></span><br><span class="line"><span class="comment">;username=user              ; (default is no username (open server))</span></span><br><span class="line"><span class="comment">;password=123               ; (default is no password (open server))</span></span><br><span class="line"></span><br><span class="line"><span class="section">[supervisorctl]</span></span><br><span class="line"><span class="comment">; 必须和'unix_http_server'里面的设定匹配</span></span><br><span class="line"><span class="comment">;serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</span></span><br><span class="line"><span class="comment">;建议修改为 /var/run 目录，避免被系统删除</span></span><br><span class="line"><span class="attr">serverurl</span>=unix:///var/run/supervisor.sock ; use a unix:// URL  for a unix socket</span><br><span class="line"><span class="comment">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket</span></span><br><span class="line"><span class="comment">;username=chris              ; should be same as http_username if set</span></span><br><span class="line"><span class="comment">;password=123                ; should be same as http_password if set</span></span><br><span class="line"></span><br><span class="line">。。。</span><br><span class="line"></span><br><span class="line"><span class="section">[include]</span></span><br><span class="line"><span class="attr">files</span> = /etc/supervisor/*.conf</span><br></pre></td></tr></table></figure>
<p>配置文件都有说明，且很简单，就不做多的描述了，在上面有一些建议修改的目录，若做了修改，则应先创建这些文件，需要注意权限问题，很多错误都是没有权限造成的。</p>
<h4 id="3-2-启动服务端"><a href="#3-2-启动服务端" class="headerlink" title="3.2 启动服务端"></a>3.2 启动服务端</h4><p>现在，让我们来启动supervisor服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>查看supervisord 是否运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep superviosrd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output:xxxx   82039      1  0 11:22 ?        00:00:00 /usr/local/bin/python /usr/local/bin/supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<h4 id="3-2-项目配置及运行"><a href="#3-2-项目配置及运行" class="headerlink" title="3.2 项目配置及运行"></a>3.2 项目配置及运行</h4><p>上面我们已经把 supervisrod 运行起来了，现在可以添加我们要管理的进程的配置文件。可以把所有配置项都写到 supervisord.conf 文件里，但并不推荐这样做，而是通过 include 的方式把不同的程序（组）写到不同的配置文件里，对，就是默认配置中的最后的那个include。下面来对项目进行简单的配置。<br>假设我们把项目配置文件放在这个目录中:<code>/etc/supervisor/</code><br>则我们需要修改<code>/etc/supervisord.conf</code> 中的include为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[include]</span></span><br><span class="line"><span class="attr">files</span> = /etc/supervisor/*.conf</span><br></pre></td></tr></table></figure>
<p>测试py文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    print(<span class="string">'i am ok'</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>以下为配置文件目录<code>/etc/supervisor/test.conf</code>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:testpy]</span></span><br><span class="line"><span class="attr">command</span>=python test.py              ; the program (relative uses PATH, can take args)</span><br><span class="line"><span class="comment">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</span></span><br><span class="line"><span class="comment">;numprocs=1                    ; number of processes copies to start (def 1)</span></span><br><span class="line"><span class="attr">directory</span>=/root/myporject/               ; directory to cwd to before exec (def <span class="literal">no</span> cwd)</span><br><span class="line"><span class="comment">;umask=022                     ; umask for process (default None)</span></span><br><span class="line"><span class="attr">priority</span>=<span class="number">999</span>                  ; the relative start priority (default <span class="number">999</span>)</span><br><span class="line"><span class="attr">startsecs</span> = <span class="number">5</span>        ; 启动 <span class="number">5</span> 秒后没有异常退出，就当作已经正常启动了</span><br><span class="line"><span class="attr">autorestart</span> = <span class="literal">true</span>   ; 程序异常退出后自动重启</span><br><span class="line"><span class="attr">startretries</span> = <span class="number">3</span>     ; 启动失败自动重试次数，默认是 <span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span> = /root/myporject/supervisor.log</span><br></pre></td></tr></table></figure>
<p>配置完成以后，即可运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>查看运行状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# supervisorctl status</span><br><span class="line">testpy                           RUNNING   pid 2391, uptime 0:00:54</span><br></pre></td></tr></table></figure>
<p>打开浏览器，输入127.0.0.9001,输入用户名与密码（如果配置文件中inet_http_server中作了设置），可以看到下面这个界面：</p>
<p><img src="https://ws1.sinaimg.cn/large/d126accegy1fyqajnbn72j20me066t8x.jpg" alt=""></p>
<h4 id="3-3-使用supervisorctl"><a href="#3-3-使用supervisorctl" class="headerlink" title="3.3 使用supervisorctl"></a>3.3 使用supervisorctl</h4><p>在启动服务之后，运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>或者直接<code>supervisorctl</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# supervisorctl</span><br><span class="line">testpy                           RUNNING   pid 2391, uptime 0:01:45</span><br></pre></td></tr></table></figure>
<p>若成功，则会进入supervisorctl的shell界面，有以下方法：</p>
<ul>
<li>status                   # 查看程序状态</li>
<li>stop testpy               # 关闭 testpy 程序</li>
<li>start testpy               # 启动 testpy 程序</li>
<li>restart testpy           # 重启 testpy 程序</li>
<li>reread                      ＃ 读取有更新（增加）的配置文件，不会启动新添加的程序</li>
<li>update                     ＃ 重启配置文件修改过的程序</li>
</ul>
<p>执行相关操作后，可以在web端看到具体的变化情况，如stop 程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop testpy</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/d126accegy1fyqaemp03ej20lv061t8y.jpg" alt=""></p>
<p>其实，也可以不使用supervisorctl shell界面，而在bash终端运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ supervisorctl status</span><br><span class="line">$ supervisorctl stop usercenter</span><br><span class="line">$ supervisorctl start usercenter</span><br><span class="line">$ supervisorctl restart usercenter</span><br><span class="line">$ supervisorctl reread</span><br><span class="line">$ supervisorctl update</span><br></pre></td></tr></table></figure>
<h4 id="3-4-多个进程管理"><a href="#3-4-多个进程管理" class="headerlink" title="3.4 多个进程管理"></a>3.4 多个进程管理</h4><p>按照官方文档的定义，一个 [program:x] 实际上是表示一组相同特征或同类的进程组，也就是说一个 [program:x] 可以启动多个进程。这组进程的成员是通过 numprocs 和 process_name 这两个参数来确定的，这句话什么意思呢，我们来看这个例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">; 设置进程的名称，使用 supervisorctl 来管理进程时需要使用该进程名</span><br><span class="line">[program:foo] </span><br><span class="line"></span><br><span class="line">; 可以在 command 这里用 python 表达式传递不同的参数给每个进程</span><br><span class="line">command=python server.py --port=90%(process_num)02d</span><br><span class="line"></span><br><span class="line">directory=/home/python/tornado_server ; 执行 command 之前，先切换到工作目录</span><br><span class="line"></span><br><span class="line">; 若 numprocs 不为1，process_name 的表达式中一定要包含 process_num 来区分不同的进程</span><br><span class="line">numprocs=2                   </span><br><span class="line">process_name=%(program_name)s_%(process_num)02d; </span><br><span class="line"></span><br><span class="line">user=oxygen                 ; 使用 oxygen 用户来启动该进程</span><br><span class="line"></span><br><span class="line">autorestart=true  ; 程序崩溃时自动重启</span><br><span class="line"></span><br><span class="line">redirect_stderr=true      ; 重定向输出的日志</span><br><span class="line"></span><br><span class="line">stdout_logfile = /var/log/supervisord/</span><br><span class="line">tornado_server.log</span><br><span class="line">loglevel=info</span><br></pre></td></tr></table></figure>
<p>上面这个例子会启动两个进程，process_name 分别为 foo:foo_01 和 foo:foo_02。通过这样一种方式，就可以用一个 [program:x] 配置项，来启动一组非常类似的进程。<br> 更详细配置，点击<a href="https://link.jianshu.com?t=http://supervisord.org/configuration.html#program-x-section-settings" target="_blank" rel="noopener">这里</a></p>
<p>Supervisor 同时还提供了另外一种进程组的管理方式，通过这种方式，可以使用 supervisorctl 命令来管理一组进程。跟 [program:x] 的进程组不同的是，这里的进程是一个个的 [program:x] 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[group:thegroupname]</span><br><span class="line">programs=progname1,progname2  ; each refers to &apos;x&apos; in [program:x] definitions</span><br><span class="line">priority=999                  ; the relative start priority (default 999)</span><br></pre></td></tr></table></figure>
<p>当添加了上述配置后，progname1 和 progname2 的进程名就会变成 thegroupname:progname1 和 thegroupname:progname2 以后就要用这个名字来管理进程了，而不是之前的 progname1。</p>
<p>以后执行 supervisorctl stop thegroupname: 就能同时结束 progname1 和 progname2，执行 supervisorctl stop thegroupname:progname1 就能结束 progname1。</p>
<h2 id="4-结尾"><a href="#4-结尾" class="headerlink" title="4. 结尾"></a>4. 结尾</h2><p>实际上，默认情况下，supervisored 也是一个进程，最理想的的情况应该是将其安装为系统服务，安装方法可以参考<a href="https://link.jianshu.com?t=http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu" target="_blank" rel="noopener">这里</a>,安装脚本参考<a href="https://link.jianshu.com?t=https://github.com/Supervisor/initscripts" target="_blank" rel="noopener">这里</a>,由于没有做具体的实验，此处不展开说明。</p>
<p>其实还有一个简单的方法，因为 Linux 在启动的时候会执行 /etc/rc.local 里面的脚本，所以只要在这里添加执行命令就可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 如果是 Ubuntu 添加以下内容</span><br><span class="line">/usr/local/bin/supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"># 如果是 Centos 添加以下内容</span><br><span class="line">/usr/bin/supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>以上内容需要添加在 exit 命令前，而且由于在执行 rc.local 脚本时，PATH 环境变量未全部初始化，因此命令需要使用绝对路径。</p>
<p>在添加前，先在终端测试一下命令是否能正常执行，如果找不到 supervisord，可以用如下命令找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo find / -name supervisord</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">/usr/local/bin/supervisord</span><br></pre></td></tr></table></figure>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><blockquote>
<p>这段日子真的很难    <a href="https://www.jianshu.com/p/bf2b3f4dec73" target="_blank" rel="noopener">https://www.jianshu.com/p/bf2b3f4dec73</a></p>
</blockquote>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://hyyc554.github.io">Yongchi</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://hyyc554.github.io/2018/12/31/Django与supervisor-管理进程/">https://hyyc554.github.io/2018/12/31/Django与supervisor-管理进程/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Django/">Django</a>
            <a href="/tags/Linux/">Linux</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2019/01/06/流畅的Python读书笔记（二）/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">流畅的Python读书笔记（二）</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2018/12/31/我的2019计划/">
        <span class="next-text nav-default">我的2019计划</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="Mi8xLzM=">
      <script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
</script>
        <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
      </div>  
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:hyc554@outlook.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/hyyc554" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yongchi</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
	(function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
