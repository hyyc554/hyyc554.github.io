

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="自律成就自我">
  <meta name="author" content="Yongchi | 粤ICP备19044639号">
  <meta name="keywords" content>
  <title>【Linux编程】进程间通信（IPC） - MadLife</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/dracula.min.css">
    
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  



<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"hyyc554.github.io","root":"/","version":"1.8.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>MadLife</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/seek.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="【Linux编程】进程间通信（IPC）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-03-21 17:32" pubdate>
        2019年3月21日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      78
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【Linux编程】进程间通信（IPC）</h1>
            
            <div class="markdown-body">
              <p>进程间通信（IPC，InterProcess Communication）**是指在不同进程之间传播或交换信息。IPC的方式通常有管道（包括无名管道和命名管道）、消息队列、信号量、共享存储、Socket、Streams等。其中 Socket和Streams支持不同主机上的两个进程IPC。<br><a id="more"></a></p>
<h2 id="一、管道"><a href="#一、管道" class="headerlink" title="一、管道"></a>一、管道</h2><p><strong>管道</strong>，通常指无名管道，是 UNIX 系统IPC最古老的形式。</p>
<h3 id="1、特点："><a href="#1、特点：" class="headerlink" title="1、特点："></a>1、特点：</h3><ol>
<li>它是半双工的（即数据只能在一个方向上流动），具有固定的读端和写端。</li>
<li>它只能用于具有亲缘关系的进程之间的通信（也是父子进程或者兄弟进程之间）。</li>
<li>它可以看成是一种特殊的文件，对于它的读写也可以使用普通的read、write 等函数。但是它不是普通的文件，并不属于其他任何文件系统，并且只存在于内存中。</li>
</ol>
<h3 id="2、原型："><a href="#2、原型：" class="headerlink" title="2、原型："></a>2、原型：</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd[<span class="hljs-number">2</span>])</span></span>;    <span class="hljs-comment">// 返回值：若成功返回0，失败返回-1</span><br></code></pre></div></td></tr></table></figure>
<p>当一个管道建立时，它会创建两个文件描述符：<code>fd[0]</code>为读而打开，<code>fd[1]</code>为写而打开。如下图：</p>
<p><a href="http://img.blog.csdn.net/20150419222058628?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" target="_blank" rel="noopener"><img src="http://img.blog.csdn.net/20150419222058628?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></a></p>
<p>要关闭管道只需将这两个文件描述符关闭即可。</p>
<h3 id="3、例子"><a href="#3、例子" class="headerlink" title="3、例子"></a>3、例子</h3><p>单个进程中的管道几乎没有任何用处。所以，通常调用 pipe 的进程接着调用 fork，这样就创建了父进程与子进程之间的 IPC 通道。如下图所示：</p>
<p><a href="http://img.blog.csdn.net/20150419223853807?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" target="_blank" rel="noopener"><img src="http://img.blog.csdn.net/20150419223853807?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img"></a></p>
<p>若要数据流从父进程流向子进程，则关闭父进程的读端（<code>fd[0]</code>）与子进程的写端（<code>fd[1]</code>）；反之，则可以使数据流从子进程流向父进程。</p>
<figure class="highlight arduino"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> fd[<span class="hljs-number">2</span>];  <span class="hljs-comment">// 两个文件描述符</span><br>	<span class="hljs-keyword">pid_t</span> pid;<br>	<span class="hljs-keyword">char</span> buff[<span class="hljs-number">20</span>];<br><br>	<span class="hljs-keyword">if</span>(pipe(fd) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 创建管道</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Create Pipe Error!\n"</span>);<br><br>	<span class="hljs-keyword">if</span>((pid = fork()) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 创建子进程</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fork Error!\n"</span>);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 父进程</span><br>	&#123;<br>		<span class="hljs-built_in">close</span>(fd[<span class="hljs-number">0</span>]); <span class="hljs-comment">// 关闭读端</span><br>		<span class="hljs-built_in">write</span>(fd[<span class="hljs-number">1</span>], <span class="hljs-string">"hello world\n"</span>, <span class="hljs-number">12</span>);<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-built_in">close</span>(fd[<span class="hljs-number">1</span>]); <span class="hljs-comment">// 关闭写端</span><br>		<span class="hljs-built_in">read</span>(fd[<span class="hljs-number">0</span>], buff, <span class="hljs-number">20</span>);<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buff);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="二、FIFO"><a href="#二、FIFO" class="headerlink" title="二、FIFO"></a>二、FIFO</h2><p><strong>FIFO</strong>，也称为命名管道，它是一种文件类型。</p>
<h3 id="1、特点"><a href="#1、特点" class="headerlink" title="1、特点"></a>1、特点</h3><ol>
<li>FIFO可以在无关的进程之间交换数据，与无名管道不同。</li>
<li>FIFO有路径名与之相关联，它以一种特殊设备文件形式存在于文件系统中。</li>
</ol>
<h3 id="2、原型"><a href="#2、原型" class="headerlink" title="2、原型"></a>2、原型</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-comment">// 返回值：成功返回0，出错返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">mkfifo</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *pathname, <span class="hljs-keyword">mode_t</span> mode)</span></span>;<br></code></pre></div></td></tr></table></figure>
<p>其中的 mode 参数与<code>open</code>函数中的 mode 相同。一旦创建了一个 FIFO，就可以用一般的文件I/O函数操作它。</p>
<p>当 open 一个FIFO时，是否设置非阻塞标志（<code>O_NONBLOCK</code>）的区别：</p>
<ul>
<li>若没有指定<code>O_NONBLOCK</code>（默认），只读 open 要阻塞到某个其他进程为写而打开此 FIFO。类似的，只写 open 要阻塞到某个其他进程为读而打开它。</li>
<li>若指定了<code>O_NONBLOCK</code>，则只读 open 立即返回。而只写 open 将出错返回 -1 如果没有进程已经为读而打开该 FIFO，其errno置ENXIO。</li>
</ul>
<h3 id="3、例子-1"><a href="#3、例子-1" class="headerlink" title="3、例子"></a>3、例子</h3><p>FIFO的通信方式类似于在进程中使用文件来传输数据，只不过FIFO类型文件同时具有管道的特性。在数据读出时，FIFO管道中同时清除数据，并且“先进先出”。下面的例子演示了使用 FIFO 进行 IPC 的过程：</p>
<ul>
<li><p><strong>write_fifo.c</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;   // exit</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;fcntl.h&gt;    // O_WRONLY</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;time.h&gt;     // time</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> fd;<br>	<span class="hljs-keyword">int</span> n, i;<br>	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">1024</span>];<br>	<span class="hljs-keyword">time_t</span> tp;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"I am %d process.\n"</span>, getpid()); <span class="hljs-comment">// 说明进程ID</span><br>	<br>	<span class="hljs-keyword">if</span>((fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">"fifo1"</span>, O_WRONLY)) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// 以写打开一个FIFO </span><br>	&#123;<br>		perror(<span class="hljs-string">"Open FIFO Failed"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; ++i)<br>	&#123;<br>		time(&amp;tp);  <span class="hljs-comment">// 取系统当前时间</span><br>		n=<span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">"Process %d's time is %s"</span>,getpid(),ctime(&amp;tp));<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Send message: %s"</span>, buf); <span class="hljs-comment">// 打印</span><br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">write</span>(fd, buf, n+<span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 写入到FIFO中</span><br>		&#123;<br>			perror(<span class="hljs-string">"Write FIFO Failed"</span>);<br>			<span class="hljs-built_in">close</span>(fd);<br>			<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>		&#125;<br>		sleep(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 休眠1秒</span><br>	&#125;<br><br>	<span class="hljs-built_in">close</span>(fd);  <span class="hljs-comment">// 关闭FIFO文件</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
<li><p><strong>read_fifo.c</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> fd;<br>	<span class="hljs-keyword">int</span> len;<br>	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">1024</span>];<br><br>	<span class="hljs-keyword">if</span>(mkfifo(<span class="hljs-string">"fifo1"</span>, <span class="hljs-number">0666</span>) &lt; <span class="hljs-number">0</span> &amp;&amp; errno!=EEXIST) <span class="hljs-comment">// 创建FIFO管道</span><br>		perror(<span class="hljs-string">"Create FIFO Failed"</span>);<br><br>	<span class="hljs-keyword">if</span>((fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">"fifo1"</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 以读打开FIFO</span><br>	&#123;<br>		perror(<span class="hljs-string">"Open FIFO Failed"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<br>	<span class="hljs-keyword">while</span>((len = <span class="hljs-built_in">read</span>(fd, buf, <span class="hljs-number">1024</span>)) &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">// 读取FIFO管道</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Read message: %s"</span>, buf);<br><br>	<span class="hljs-built_in">close</span>(fd);  <span class="hljs-comment">// 关闭FIFO文件</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
<p>在两个终端里用 gcc 分别编译运行上面两个文件，可以看到输出结果如下：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined">[songlee@localhost]$ ./write_fifo <br>I am <span class="hljs-number">5954</span> <span class="hljs-keyword">process</span>.<br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">28</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">30</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">31</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">32</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">33</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">34</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">36</span> <span class="hljs-number">2015</span><br>Send message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">37</span> <span class="hljs-number">2015</span><br></code></pre></div></td></tr></table></figure>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined">[songlee@localhost]$ ./read_fifo <br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">28</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">30</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">31</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">32</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">33</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">34</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">36</span> <span class="hljs-number">2015</span><br>Read message: <span class="hljs-keyword">Process</span> <span class="hljs-number">5954</span><span class="hljs-symbol">'s</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">is</span> Mon Apr <span class="hljs-number">20</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">37</span> <span class="hljs-number">2015</span><br></code></pre></div></td></tr></table></figure>
<p>上述例子可以扩展成 客户进程—服务器进程 通信的实例，<code>write_fifo</code>的作用类似于客户端，可以打开多个客户端向一个服务器发送请求信息，<code>read_fifo</code>类似于服务器，它适时监控着FIFO的读端，当有数据时，读出并进行处理，但是有一个关键的问题是，每一个客户端必须预先知道服务器提供的FIFO接口，下图显示了这种安排：</p>
<p><a href="http://img.blog.csdn.net/20150420131002360?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" target="_blank" rel="noopener"><img src="http://img.blog.csdn.net/20150420131002360?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlzb25nbGlzb25nbGlzb25n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></a></p>
<h2 id="三、消息队列"><a href="#三、消息队列" class="headerlink" title="三、消息队列"></a>三、消息队列</h2><p><strong>消息队列</strong>，是消息的链接表，存放在内核中。一个消息队列由一个标识符（即队列ID）来标识。</p>
<h3 id="1、特点-1"><a href="#1、特点-1" class="headerlink" title="1、特点"></a>1、特点</h3><ol>
<li>消息队列是面向记录的，其中的消息具有特定的格式以及特定的优先级。</li>
<li>消息队列独立于发送与接收进程。进程终止时，消息队列及其内容并不会被删除。</li>
<li>消息队列可以实现消息的随机查询,消息不一定要以先进先出的次序读取,也可以按消息的类型读取。</li>
</ol>
<h3 id="2、原型-1"><a href="#2、原型-1" class="headerlink" title="2、原型"></a>2、原型</h3><figure class="highlight arduino"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-comment">// 创建或打开消息队列：成功返回队列ID，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msgget</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key, <span class="hljs-keyword">int</span> flag)</span></span>;<br><span class="hljs-comment">// 添加消息：成功返回0，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msgsnd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> msqid, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *ptr, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>, <span class="hljs-keyword">int</span> flag)</span></span>;<br><span class="hljs-comment">// 读取消息：成功返回消息数据的长度，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msgrcv</span><span class="hljs-params">(<span class="hljs-keyword">int</span> msqid, <span class="hljs-keyword">void</span> *ptr, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>, <span class="hljs-keyword">long</span> type,<span class="hljs-keyword">int</span> flag)</span></span>;<br><span class="hljs-comment">// 控制消息队列：成功返回0，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msgctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> msqid, <span class="hljs-keyword">int</span> cmd, struct msqid_ds *buf)</span></span>;<br></code></pre></div></td></tr></table></figure>
<p>在以下两种情况下，<code>msgget</code>将创建一个新的消息队列：</p>
<ul>
<li>如果没有与键值key相对应的消息队列，并且flag中包含了<code>IPC_CREAT</code>标志位。</li>
<li>key参数为<code>IPC_PRIVATE</code>。</li>
</ul>
<p>函数<code>msgrcv</code>在读取消息队列时，type参数有下面几种情况：</p>
<ul>
<li><code>type == 0</code>，返回队列中的第一个消息；</li>
<li><code>type &gt; 0</code>，返回队列中消息类型为 type 的第一个消息；</li>
<li><code>type &lt; 0</code>，返回队列中消息类型值小于或等于 type 绝对值的消息，如果有多个，则取类型值最小的消息。</li>
</ul>
<p>可以看出，type值非 0 时用于以非先进先出次序读消息。也可以把 type 看做优先级的权值。（其他的参数解释，请自行Google之）</p>
<h3 id="3、例子-2"><a href="#3、例子-2" class="headerlink" title="3、例子"></a>3、例子</h3><p>下面写了一个简单的使用消息队列进行IPC的例子，服务端程序一直在等待特定类型的消息，当收到该类型的消息以后，发送另一种特定类型的消息作为反馈，客户端读取该反馈并打印出来。</p>
<ul>
<li><p><strong>msg_server.c</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-comment">// 用于创建一个唯一的key</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSG_FILE <span class="hljs-meta-string">"/etc/passwd"</span></span><br><br><span class="hljs-comment">// 消息结构</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> &#123;</span><br>	<span class="hljs-keyword">long</span> mtype;<br>	<span class="hljs-keyword">char</span> mtext[<span class="hljs-number">256</span>];<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> msqid;<br>	<span class="hljs-keyword">key_t</span> key;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> <span class="hljs-title">msg</span>;</span><br>	<br>	<span class="hljs-comment">// 获取key值</span><br>	<span class="hljs-keyword">if</span>((key = ftok(MSG_FILE,<span class="hljs-string">'z'</span>)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"ftok error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 打印key值</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Message Queue - Server key is: %d.\n"</span>, key);<br><br>	<span class="hljs-comment">// 创建消息队列</span><br>	<span class="hljs-keyword">if</span> ((msqid = msgget(key, IPC_CREAT|<span class="hljs-number">0777</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"msgget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 打印消息队列ID及进程ID</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"My msqid is: %d.\n"</span>, msqid);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"My pid is: %d.\n"</span>, getpid());<br><br>	<span class="hljs-comment">// 循环读取消息</span><br>	<span class="hljs-keyword">for</span>(;;) <br>	&#123;<br>		msgrcv(msqid, &amp;msg, <span class="hljs-number">256</span>, <span class="hljs-number">888</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">// 返回类型为888的第一个消息</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server: receive msg.mtext is: %s.\n"</span>, msg.mtext);<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server: receive msg.mtype is: %d.\n"</span>, msg.mtype);<br><br>		msg.mtype = <span class="hljs-number">999</span>; <span class="hljs-comment">// 客户端接收的消息类型</span><br>		<span class="hljs-built_in">sprintf</span>(msg.mtext, <span class="hljs-string">"hello, I'm server %d"</span>, getpid());<br>		msgsnd(msqid, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg.mtext), <span class="hljs-number">0</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
<li><p><strong>msg_client.c</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-comment">// 用于创建一个唯一的key</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSG_FILE <span class="hljs-meta-string">"/etc/passwd"</span></span><br><br><span class="hljs-comment">// 消息结构</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> &#123;</span><br>	<span class="hljs-keyword">long</span> mtype;<br>	<span class="hljs-keyword">char</span> mtext[<span class="hljs-number">256</span>];<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> msqid;<br>	<span class="hljs-keyword">key_t</span> key;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> <span class="hljs-title">msg</span>;</span><br><br>	<span class="hljs-comment">// 获取key值</span><br>	<span class="hljs-keyword">if</span> ((key = ftok(MSG_FILE, <span class="hljs-string">'z'</span>)) &lt; <span class="hljs-number">0</span>) <br>	&#123;<br>		perror(<span class="hljs-string">"ftok error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 打印key值</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Message Queue - Client key is: %d.\n"</span>, key);<br><br>	<span class="hljs-comment">// 打开消息队列</span><br>	<span class="hljs-keyword">if</span> ((msqid = msgget(key, IPC_CREAT|<span class="hljs-number">0777</span>)) == <span class="hljs-number">-1</span>) <br>	&#123;<br>		perror(<span class="hljs-string">"msgget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 打印消息队列ID及进程ID</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"My msqid is: %d.\n"</span>, msqid);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"My pid is: %d.\n"</span>, getpid());<br><br>	<span class="hljs-comment">// 添加消息，类型为888</span><br>	msg.mtype = <span class="hljs-number">888</span>;<br>	<span class="hljs-built_in">sprintf</span>(msg.mtext, <span class="hljs-string">"hello, I'm client %d"</span>, getpid());<br>	msgsnd(msqid, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg.mtext), <span class="hljs-number">0</span>);<br><br>	<span class="hljs-comment">// 读取类型为777的消息</span><br>	msgrcv(msqid, &amp;msg, <span class="hljs-number">256</span>, <span class="hljs-number">999</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Client: receive msg.mtext is: %s.\n"</span>, msg.mtext);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Client: receive msg.mtype is: %d.\n"</span>, msg.mtype);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
<h2 id="四、信号量"><a href="#四、信号量" class="headerlink" title="四、信号量"></a>四、信号量</h2><p><strong>信号量（semaphore）</strong>与已经介绍过的 IPC 结构不同，它是一个计数器。信号量用于实现进程间的互斥与同步，而不是用于存储进程间通信数据。</p>
<h3 id="1、特点-2"><a href="#1、特点-2" class="headerlink" title="1、特点"></a>1、特点</h3><ol>
<li>信号量用于进程间同步，若要在进程间传递数据需要结合<em>共享内存</em>。</li>
<li>信号量基于操作系统的 PV 操作，程序对信号量的操作都是原子操作。</li>
<li>每次对信号量的 PV 操作不仅限于对信号量值加 1 或减 1，而且可以加减任意正整数。</li>
<li>支持信号量组。</li>
</ol>
<h3 id="2、原型-2"><a href="#2、原型-2" class="headerlink" title="2、原型"></a>2、原型</h3><p>最简单的信号量是只能取 0 和 1 的变量，这也是信号量最常见的一种形式，叫做<strong>二值信号量（Binary Semaphore）</strong>。而可以取多个正整数的信号量被称为通用信号量。</p>
<p>Linux 下的信号量函数都是在通用的信号量数组上进行操作，而不是在一个单一的二值信号量上进行操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-comment">// 创建或获取一个信号量组：若成功返回信号量集ID，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">semget</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key, <span class="hljs-keyword">int</span> num_sems, <span class="hljs-keyword">int</span> sem_flags)</span></span>;<br><span class="hljs-comment">// 对信号量组进行操作，改变信号量的值：成功返回0，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">semop</span><span class="hljs-params">(<span class="hljs-keyword">int</span> semid, struct sembuf semoparray[], <span class="hljs-keyword">size_t</span> numops)</span></span>;  <br><span class="hljs-comment">// 控制信号量的相关信息</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">semctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> semid, <span class="hljs-keyword">int</span> sem_num, <span class="hljs-keyword">int</span> cmd, ...)</span></span>;<br></code></pre></div></td></tr></table></figure>
<p>当<code>semget</code>创建新的信号量集合时，必须指定集合中信号量的个数（即<code>num_sems</code>），通常为1； 如果是引用一个现有的集合，则将<code>num_sems</code>指定为 0 。</p>
<p>在<code>semop</code>函数中，<code>sembuf</code>结构的定义如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-keyword">struct</span> sembuf <br>&#123;<br>    <span class="hljs-keyword">short</span> sem_num; <span class="hljs-comment">// 信号量组中对应的序号，0～sem_nums-1</span><br>    <span class="hljs-keyword">short</span> sem_op;  <span class="hljs-comment">// 信号量值在一次操作中的改变量</span><br>    <span class="hljs-keyword">short</span> sem_flg; <span class="hljs-comment">// IPC_NOWAIT, SEM_UNDO</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>其中 sem_op 是一次操作中的信号量的改变量：</p>
<ul>
<li><p>若<code>sem_op &gt; 0</code>，表示进程释放相应的资源数，将 sem_op 的值加到信号量的值上。如果有进程正在休眠等待此信号量，则换行它们。</p>
</li>
<li><p>若<code>sem_op &lt; 0</code>，请求 sem_op 的绝对值的资源。</p>
<ul>
<li><p>如果相应的资源数可以满足请求，则将该信号量的值减去sem_op的绝对值，函数成功返回。</p>
</li>
<li><p>当相应的资源数不能满足请求时，这个操作与</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-attribute">sem_flg</span><br></code></pre></div></td></tr></table></figure>
<p>有关。</p>
<ul>
<li><p>sem_flg 指定<code>IPC_NOWAIT</code>，则semop函数出错返回<code>EAGAIN</code>。</p>
</li>
<li><p>sem_flg 没有指定</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-attribute">IPC_NOWAIT</span><br></code></pre></div></td></tr></table></figure>
<p>，则将该信号量的semncnt值加1，然后进程挂起直到下述情况发生：</p>
<ol>
<li>当相应的资源数可以满足请求，此信号量的semncnt值减1，该信号量的值减去sem_op的绝对值。成功返回；</li>
<li>此信号量被删除，函数smeop出错返回EIDRM；</li>
<li>进程捕捉到信号，并从信号处理函数返回，此情况下将此信号量的semncnt值减1，函数semop出错返回EINTR</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li><p>若<code>sem_op == 0</code>，进程阻塞直到信号量的相应值为0：</p>
<ul>
<li><p>当信号量已经为0，函数立即返回。</p>
</li>
<li><p>如果信号量的值不为0，则依据</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-attribute">sem_flg</span><br></code></pre></div></td></tr></table></figure>
<p>决定函数动作：</p>
<ul>
<li><p>sem_flg指定<code>IPC_NOWAIT</code>，则出错返回<code>EAGAIN</code>。</p>
</li>
<li><p>sem_flg没有指定</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-attribute">IPC_NOWAIT</span><br></code></pre></div></td></tr></table></figure>
<p>，则将该信号量的semncnt值加1，然后进程挂起直到下述情况发生：</p>
<ol>
<li>信号量值为0，将信号量的semzcnt的值减1，函数semop成功返回；</li>
<li>此信号量被删除，函数smeop出错返回EIDRM；</li>
<li>进程捕捉到信号，并从信号处理函数返回，在此情况将此信号量的semncnt值减1，函数semop出错返回EINTR</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在<code>semctl</code>函数中的命令有多种，这里就说两个常用的：</p>
<ul>
<li><code>SETVAL</code>：用于初始化信号量为一个已知的值。所需要的值作为联合semun的val成员来传递。在信号量第一次使用之前需要设置信号量。</li>
<li><code>IPC_RMID</code>：删除一个信号量集合。如果不删除信号量，它将继续在系统中存在，即使程序已经退出，它可能在你下次运行此程序时引发问题，而且信号量是一种有限的资源。</li>
</ul>
<h3 id="3、例子-3"><a href="#3、例子-3" class="headerlink" title="3、例子"></a>3、例子</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><br><span class="hljs-comment">// 联合体，用于semctl初始化</span><br><span class="hljs-keyword">union</span> semun<br>&#123;<br>	<span class="hljs-keyword">int</span>              val; <span class="hljs-comment">/*for SETVAL*/</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span><br>	<span class="hljs-keyword">unsigned</span> short  *<span class="hljs-built_in">array</span>;<br>&#125;;<br><br><span class="hljs-comment">// 初始化信号量</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">init_sem</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id, <span class="hljs-keyword">int</span> value)</span><br></span>&#123;<br>	<span class="hljs-keyword">union</span> semun tmp;<br>	tmp.val = value;<br>	<span class="hljs-keyword">if</span>(semctl(sem_id, <span class="hljs-number">0</span>, SETVAL, tmp) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"Init Semaphore Error"</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// P操作:</span><br><span class="hljs-comment">//	若信号量值为1，获取资源并将信号量值-1 </span><br><span class="hljs-comment">//	若信号量值为0，进程挂起等待</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_p</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>	sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>	sbuf.sem_op = <span class="hljs-number">-1</span>; <span class="hljs-comment">/*P操作*/</span><br>	sbuf.sem_flg = SEM_UNDO;<br><br>	<span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"P operation Error"</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// V操作：</span><br><span class="hljs-comment">//	释放资源并将信号量值+1</span><br><span class="hljs-comment">//	如果有进程正在挂起等待，则唤醒它们</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_v</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>	sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>	sbuf.sem_op = <span class="hljs-number">1</span>;  <span class="hljs-comment">/*V操作*/</span><br>	sbuf.sem_flg = SEM_UNDO;<br><br>	<span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"V operation Error"</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// 删除信号量集</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">del_sem</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>	<span class="hljs-keyword">union</span> semun tmp;<br>	<span class="hljs-keyword">if</span>(semctl(sem_id, <span class="hljs-number">0</span>, IPC_RMID, tmp) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"Delete Semaphore Error"</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> sem_id;  <span class="hljs-comment">// 信号量集ID</span><br>	<span class="hljs-keyword">key_t</span> key;  <br>	<span class="hljs-keyword">pid_t</span> pid;<br><br>	<span class="hljs-comment">// 获取key值</span><br>	<span class="hljs-keyword">if</span>((key = ftok(<span class="hljs-string">"."</span>, <span class="hljs-string">'z'</span>)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"ftok error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 创建信号量集，其中只有一个信号量</span><br>	<span class="hljs-keyword">if</span>((sem_id = semget(key, <span class="hljs-number">1</span>, IPC_CREAT|<span class="hljs-number">0666</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"semget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 初始化：初值设为0资源被占用</span><br>	init_sem(sem_id, <span class="hljs-number">0</span>);<br><br>	<span class="hljs-keyword">if</span>((pid = fork()) == <span class="hljs-number">-1</span>)<br>		perror(<span class="hljs-string">"Fork Error"</span>);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) <span class="hljs-comment">/*子进程*/</span> <br>	&#123;<br>		sleep(<span class="hljs-number">2</span>);<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Process child: pid=%d\n"</span>, getpid());<br>		sem_v(sem_id);  <span class="hljs-comment">/*释放资源*/</span><br>	&#125;<br>	<span class="hljs-keyword">else</span>  <span class="hljs-comment">/*父进程*/</span><br>	&#123;<br>		sem_p(sem_id);   <span class="hljs-comment">/*等待资源*/</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Process father: pid=%d\n"</span>, getpid());<br>		sem_v(sem_id);   <span class="hljs-comment">/*释放资源*/</span><br>		del_sem(sem_id); <span class="hljs-comment">/*删除信号量集*/</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的例子如果不加信号量，则父进程会先执行完毕。这里加了信号量让父进程等待子进程执行完以后再执行。</p>
<h2 id="五、共享内存"><a href="#五、共享内存" class="headerlink" title="五、共享内存"></a>五、共享内存</h2><p><strong>共享内存（Shared Memory）</strong>，指两个或多个进程共享一个给定的存储区。</p>
<h3 id="1、特点-3"><a href="#1、特点-3" class="headerlink" title="1、特点"></a>1、特点</h3><ol>
<li>共享内存是最快的一种 IPC，因为进程是直接对内存进行存取。</li>
<li>因为多个进程可以同时操作，所以需要进行同步。</li>
<li>信号量+共享内存通常结合在一起使用，信号量用来同步对共享内存的访问。</li>
</ol>
<h3 id="2、原型-3"><a href="#2、原型-3" class="headerlink" title="2、原型"></a>2、原型</h3><figure class="highlight arduino"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-comment">// 创建或获取一个共享内存：成功返回共享内存ID，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmget</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>, <span class="hljs-keyword">int</span> flag)</span></span>;<br><span class="hljs-comment">// 连接共享内存到当前进程的地址空间：成功返回指向共享内存的指针，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">shmat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *addr, <span class="hljs-keyword">int</span> flag)</span></span>;<br><span class="hljs-comment">// 断开与共享内存的连接：成功返回0，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmdt</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *addr)</span></span>; <br><span class="hljs-comment">// 控制共享内存的相关信息：成功返回0，失败返回-1</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">int</span> cmd, struct shmid_ds *buf)</span></span>;<br></code></pre></div></td></tr></table></figure>
<p>当用<code>shmget</code>函数创建一段共享内存时，必须指定其 size；而如果引用一个已存在的共享内存，则将 size 指定为0 。</p>
<p>当一段共享内存被创建以后，它并不能被任何进程访问。必须使用<code>shmat</code>函数连接该共享内存到当前进程的地址空间，连接成功后把共享内存区对象映射到调用进程的地址空间，随后可像本地空间一样访问。</p>
<p><code>shmdt</code>函数是用来断开<code>shmat</code>建立的连接的。注意，这并不是从系统中删除该共享内存，只是当前进程不能再访问该共享内存而已。</p>
<p><code>shmctl</code>函数可以对共享内存执行多种操作，根据参数 cmd 执行相应的操作。常用的是<code>IPC_RMID</code>（从系统中删除该共享内存）。</p>
<h3 id="3、例子-4"><a href="#3、例子-4" class="headerlink" title="3、例子"></a>3、例子</h3><p>下面这个例子，使用了<strong>【共享内存+信号量+消息队列】</strong>的组合来实现服务器进程与客户进程间的通信。</p>
<ul>
<li>共享内存用来传递数据；</li>
<li>信号量用来同步；</li>
<li>消息队列用来 在客户端修改了共享内存后 通知服务器读取。</li>
</ul>
<p><strong>Server.c</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/shm.h&gt;  // shared memory</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/sem.h&gt;  // semaphore</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/msg.h&gt;  // message queue</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;string.h&gt;   // memcpy</span></span><br><br><span class="hljs-comment">// 消息队列结构</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> &#123;</span><br>    <span class="hljs-keyword">long</span> mtype;<br>    <span class="hljs-keyword">char</span> mtext;<br>&#125;;<br><br><span class="hljs-comment">// 联合体，用于semctl初始化</span><br><span class="hljs-keyword">union</span> semun<br>&#123;<br>    <span class="hljs-keyword">int</span>              val; <span class="hljs-comment">/*for SETVAL*/</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span><br>    <span class="hljs-keyword">unsigned</span> short  *<span class="hljs-built_in">array</span>;<br>&#125;;<br><br><span class="hljs-comment">// 初始化信号量</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">init_sem</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id, <span class="hljs-keyword">int</span> value)</span><br></span>&#123;<br>    <span class="hljs-keyword">union</span> semun tmp;<br>    tmp.val = value;<br>    <span class="hljs-keyword">if</span>(semctl(sem_id, <span class="hljs-number">0</span>, SETVAL, tmp) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"Init Semaphore Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// P操作:</span><br><span class="hljs-comment">//  若信号量值为1，获取资源并将信号量值-1 </span><br><span class="hljs-comment">//  若信号量值为0，进程挂起等待</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_p</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>    sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>    sbuf.sem_op = <span class="hljs-number">-1</span>; <span class="hljs-comment">/*P操作*/</span><br>    sbuf.sem_flg = SEM_UNDO;<br><br>    <span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"P operation Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// V操作：</span><br><span class="hljs-comment">//  释放资源并将信号量值+1</span><br><span class="hljs-comment">//  如果有进程正在挂起等待，则唤醒它们</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_v</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>    sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>    sbuf.sem_op = <span class="hljs-number">1</span>;  <span class="hljs-comment">/*V操作*/</span><br>    sbuf.sem_flg = SEM_UNDO;<br><br>    <span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"V operation Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// 删除信号量集</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">del_sem</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>    <span class="hljs-keyword">union</span> semun tmp;<br>    <span class="hljs-keyword">if</span>(semctl(sem_id, <span class="hljs-number">0</span>, IPC_RMID, tmp) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"Delete Semaphore Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// 创建一个信号量集</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">creat_sem</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key)</span><br></span>&#123;<br>	<span class="hljs-keyword">int</span> sem_id;<br>	<span class="hljs-keyword">if</span>((sem_id = semget(key, <span class="hljs-number">1</span>, IPC_CREAT|<span class="hljs-number">0666</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"semget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>	init_sem(sem_id, <span class="hljs-number">1</span>);  <span class="hljs-comment">/*初值设为1资源未占用*/</span><br>	<span class="hljs-keyword">return</span> sem_id;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">key_t</span> key;<br>	<span class="hljs-keyword">int</span> shmid, semid, msqid;<br>	<span class="hljs-keyword">char</span> *shm;<br>	<span class="hljs-keyword">char</span> data[] = <span class="hljs-string">"this is server"</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> <span class="hljs-title">buf1</span>;</span>  <span class="hljs-comment">/*用于删除共享内存*/</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msqid_ds</span> <span class="hljs-title">buf2</span>;</span>  <span class="hljs-comment">/*用于删除消息队列*/</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> <span class="hljs-title">msg</span>;</span>  <span class="hljs-comment">/*消息队列用于通知对方更新了共享内存*/</span><br><br>	<span class="hljs-comment">// 获取key值</span><br>	<span class="hljs-keyword">if</span>((key = ftok(<span class="hljs-string">"."</span>, <span class="hljs-string">'z'</span>)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"ftok error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 创建共享内存</span><br>	<span class="hljs-keyword">if</span>((shmid = shmget(key, <span class="hljs-number">1024</span>, IPC_CREAT|<span class="hljs-number">0666</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"Create Shared Memory Error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 连接共享内存</span><br>	shm = (<span class="hljs-keyword">char</span>*)shmat(shmid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span>((<span class="hljs-keyword">int</span>)shm == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"Attach Shared Memory Error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br><br>	<span class="hljs-comment">// 创建消息队列</span><br>	<span class="hljs-keyword">if</span> ((msqid = msgget(key, IPC_CREAT|<span class="hljs-number">0777</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"msgget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 创建信号量</span><br>	semid = creat_sem(key);<br>	<br>	<span class="hljs-comment">// 读数据</span><br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>	&#123;<br>		msgrcv(msqid, &amp;msg, <span class="hljs-number">1</span>, <span class="hljs-number">888</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">/*读取类型为888的消息*/</span><br>		<span class="hljs-keyword">if</span>(msg.mtext == <span class="hljs-string">'q'</span>)  <span class="hljs-comment">/*quit - 跳出循环*/</span> <br>			<span class="hljs-keyword">break</span>;<br>		<span class="hljs-keyword">if</span>(msg.mtext == <span class="hljs-string">'r'</span>)  <span class="hljs-comment">/*read - 读共享内存*/</span><br>		&#123;<br>			sem_p(semid);<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>,shm);<br>			sem_v(semid);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 断开连接</span><br>	shmdt(shm);<br><br>    <span class="hljs-comment">/*删除共享内存、消息队列、信号量*/</span><br>	shmctl(shmid, IPC_RMID, &amp;buf1);<br>	msgctl(msqid, IPC_RMID, &amp;buf2);<br>	del_sem(semid);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>Client.c</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/shm.h&gt;  // shared memory</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/sem.h&gt;  // semaphore</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/msg.h&gt;  // message queue</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;string.h&gt;   // memcpy</span></span><br><br><span class="hljs-comment">// 消息队列结构</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> &#123;</span><br>    <span class="hljs-keyword">long</span> mtype;<br>    <span class="hljs-keyword">char</span> mtext;<br>&#125;;<br><br><span class="hljs-comment">// 联合体，用于semctl初始化</span><br><span class="hljs-keyword">union</span> semun<br>&#123;<br>    <span class="hljs-keyword">int</span>              val; <span class="hljs-comment">/*for SETVAL*/</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span><br>    <span class="hljs-keyword">unsigned</span> short  *<span class="hljs-built_in">array</span>;<br>&#125;;<br><br><span class="hljs-comment">// P操作:</span><br><span class="hljs-comment">//  若信号量值为1，获取资源并将信号量值-1 </span><br><span class="hljs-comment">//  若信号量值为0，进程挂起等待</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_p</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>    sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>    sbuf.sem_op = <span class="hljs-number">-1</span>; <span class="hljs-comment">/*P操作*/</span><br>    sbuf.sem_flg = SEM_UNDO;<br><br>    <span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"P operation Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// V操作：</span><br><span class="hljs-comment">//  释放资源并将信号量值+1</span><br><span class="hljs-comment">//  如果有进程正在挂起等待，则唤醒它们</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_v</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sem_id)</span><br></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sbuf</span>;</span><br>    sbuf.sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">/*序号*/</span><br>    sbuf.sem_op = <span class="hljs-number">1</span>;  <span class="hljs-comment">/*V操作*/</span><br>    sbuf.sem_flg = SEM_UNDO;<br><br>    <span class="hljs-keyword">if</span>(semop(sem_id, &amp;sbuf, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">"V operation Error"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span><br></span>&#123;<br>	<span class="hljs-keyword">key_t</span> key;<br>	<span class="hljs-keyword">int</span> shmid, semid, msqid;<br>	<span class="hljs-keyword">char</span> *shm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_form</span> <span class="hljs-title">msg</span>;</span><br>	<span class="hljs-keyword">int</span> flag = <span class="hljs-number">1</span>; <span class="hljs-comment">/*while循环条件*/</span><br><br>	<span class="hljs-comment">// 获取key值</span><br>	<span class="hljs-keyword">if</span>((key = ftok(<span class="hljs-string">"."</span>, <span class="hljs-string">'z'</span>)) &lt; <span class="hljs-number">0</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"ftok error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 获取共享内存</span><br>	<span class="hljs-keyword">if</span>((shmid = shmget(key, <span class="hljs-number">1024</span>, <span class="hljs-number">0</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"shmget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 连接共享内存</span><br>	shm = (<span class="hljs-keyword">char</span>*)shmat(shmid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span>((<span class="hljs-keyword">int</span>)shm == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"Attach Shared Memory Error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 创建消息队列</span><br>	<span class="hljs-keyword">if</span> ((msqid = msgget(key, <span class="hljs-number">0</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"msgget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 获取信号量</span><br>	<span class="hljs-keyword">if</span>((semid = semget(key, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) == <span class="hljs-number">-1</span>)<br>	&#123;<br>		perror(<span class="hljs-string">"semget error"</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	<br>	<span class="hljs-comment">// 写数据</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"***************************************\n"</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"*                 IPC                 *\n"</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"*    Input r to send data to server.  *\n"</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"*    Input q to quit.                 *\n"</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"***************************************\n"</span>);<br>	<br>	<span class="hljs-keyword">while</span>(flag)<br>	&#123;<br>		<span class="hljs-keyword">char</span> c;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input command: "</span>);<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%c"</span>, &amp;c);<br>		<span class="hljs-keyword">switch</span>(c)<br>		&#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-string">'r'</span>:<br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data to send: "</span>);<br>				sem_p(semid);  <span class="hljs-comment">/*访问资源*/</span><br>				<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%s"</span>, shm);<br>				sem_v(semid);  <span class="hljs-comment">/*释放资源*/</span><br>				<span class="hljs-comment">/*清空标准输入缓冲区*/</span><br>				<span class="hljs-keyword">while</span>((c=getchar())!=<span class="hljs-string">'\n'</span> &amp;&amp; c!=EOF);<br>				msg.mtype = <span class="hljs-number">888</span>;  <br>				msg.mtext = <span class="hljs-string">'r'</span>;  <span class="hljs-comment">/*发送消息通知服务器读数据*/</span><br>				msgsnd(msqid, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg.mtext), <span class="hljs-number">0</span>);<br>				<span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">case</span> <span class="hljs-string">'q'</span>:<br>				msg.mtype = <span class="hljs-number">888</span>;<br>				msg.mtext = <span class="hljs-string">'q'</span>;<br>				msgsnd(msqid, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg.mtext), <span class="hljs-number">0</span>);<br>				flag = <span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">default</span>:<br>				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Wrong input!\n"</span>);<br>				<span class="hljs-comment">/*清空标准输入缓冲区*/</span><br>				<span class="hljs-keyword">while</span>((c=getchar())!=<span class="hljs-string">'\n'</span> &amp;&amp; c!=EOF);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 断开连接</span><br>	shmdt(shm);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>注意：当<code>scanf()</code>输入字符或字符串时，缓冲区中遗留下了<code>\n</code>，所以每次输入操作后都需要清空标准输入的缓冲区。但是由于 gcc 编译器不支持<code>fflush(stdin)</code>（它只是标准C的扩展），所以我们使用了替代方案：</p>
<figure class="highlight lisp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs undefined">while((<span class="hljs-name">c=getchar</span>())!='\n' <span class="hljs-symbol">&amp;&amp;</span> c!=EOF)<span class="hljs-comment">;</span><br></code></pre></div></td></tr></table></figure>
<p>注释已经很详细了，所以代码的其他部分我就不解释了，下面是运行结果截图</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Linux/">Linux</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/04/05/278问题描述/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">278. 第一个错误的版本</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/03/08/14. 不修改数组找出重复的数字/">
                        <span class="hidden-mobile">14. 不修改数组找出重复的数字</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="lv-container" data-id="city" data-uid="MTAyMC8zNzIxMi8xMzc0Ng==">
    <script type="text/javascript">
      Fluid.utils.waitElementVisible('lv-container', function() {
        Fluid.utils.createScript('https://cdn-city.livere.com/js/embed.dist.js');
      });
    </script>
    <noscript>为正常使用来必力评论功能请允许 JavaScript 运行</noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备2020133205号
      </a>
    </span>
    
  </div>


  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
