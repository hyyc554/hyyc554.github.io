---
title: MySQL为什么表数据删掉一半，表文件大小不变？
tags:
 - MySQL
categories:
 - 数据库
---

## 一、引子

经常会有同学来问我，我的数据库占用空间太大，我把一个最大的表我把一个最大的表删掉了一半的数据，怎么表文件的大小还是没变？
<!-- more -->

## 二、问题来源

### 1. innodb的表数据存在方式

一个 InnoDB 表包含两部分：

1. 表结构定义（MySQL8.0之前存在于.frm 为后缀的文件，占用空间小）

2. 数据

### 2. 参数 innodb_file_per_table

表数据既可以存在共享表空间里，也可以是单独的文件。

这个行为是由参数 `innodb_file_per_table` 控制的：

1. 这个参数设置为 `OFF` 表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；
2. 这个参数设置为 `ON` 表示的是，每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。

*从 MySQL 5.6.6 版本开始，默认值值为ON* 

### 3. 数据删除流程

![VEhXef.png](https://s2.ax1x.com/2019/05/26/VEhXef.png)

假设，我们要删掉 R4 这个记录:

- InnoDB 引擎只会把 R4 这个记录标记为删除。

- 如果之后要再插入一个 ID 在 300 和 600 之间的记录时，可能会复用这个位置。

- 但是，磁盘文件的大小并不会缩小。

现在，你已经知道了 InnoDB 的数据是按页存储的，那么如果我们删掉了一个数据页上的所有记录，会怎么样？

答案是，整个数据页就可以被复用了。

但是，数据页的复用跟记录的复用是不同的。

记录的复用，只限于符合范围条件的数据。比如上面的这个例子，R4 这条记录被删除后，如果插入一个 ID 是 400 的行，可以直接复用这个空间。但如果插入的是一个 ID 是 800 的行，就不能复用这个位置了。

而当整个页从 B+ 树里面摘掉以后，可以复用到任何位置。以图 1 为例，如果将数据页 page A 上的所有记录删除以后，page A 会被标记为可复用。这时候如果要插入一条 ID=50 的记录需要使用新页的时候，page A 是可以被复用的。

如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用。

进一步地，如果我们用 delete 命令把整个表的数据删除呢？结果就是，所有的数据页都会被标记为可复用。但是磁盘上，文件不会变小。

#### 4. 数据空洞

你现在知道了，delete 命令其实只是把记录的位置，或者数据页标记为了“可复用”，但磁盘文件的大小是不会变的。也就是说，通过 delete 命令是不能回收表空间的。这些可以复用，而没有被使用的空间，看起来就像是“空洞”。

实际上，不止是删除数据会造成空洞，插入数据也会。

如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂。

可以看到，由于 page A 满了，再插入一个 ID 是 550 的数据时，就不得不再申请一个新的页面 page B 来保存数据了。页分裂完成后，page A 的末尾就留下了空洞（注意：实际上，可能不止 1 个记录的位置是空洞）。

另外，更新索引上的值，可以理解为删除一个旧的值，再插入一个新值。不难理解，这也是会造成空洞的。

数据空洞

也就是说，经过大量增删改的表，都是可能是存在空洞的。

**所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。**

## 三、问题解决方案——重建表

### 1.使用 alter table A engine=InnoDB 命令来重建表

执行流程：

1. 建立一个临时文件，扫描表 A 主键的所有数据页；
2. 用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；
3. 生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；
4. 临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3 的状态；
5. 用临时文件替换表 A 的数据文件。

示意图：

![2d1cfbbeb013b851a56390d38b5321f0.png](https://i.loli.net/2019/05/26/5cea58c24c7b970890.png)

